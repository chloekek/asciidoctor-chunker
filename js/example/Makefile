#
# This file is a part of Asciidoctor Chunker project.
# Copyright (c) 2018 wshito (@waterloo_jp)
#

ASCIIDOCTOR_CHUNKER_SCRIPT = node dist/asciidoctor-chunker.js

SINGLE_OUTPUT   = output-single
CHUNK_OUTPUT    = output-chunk


SINGLE_DIR     := $(SINGLE_OUTPUT)/single
CHUNK_DIR      := $(CHUNK_OUTPUT)/html_chunk
SINGLE_IMG_DIR := $(SINGLE_OUTPUT)/images

SINGLE := $(SINGLE_DIR)/user-manual.html
CHUNK  := $(CHUNK_DIR)/index.html

# FOOTER = -a last-update-label="This chunked html is generated by <a href='https://github.com/wshito/asciidoctor-chunker' style='color: white; text-decoration: underline'>Asciidoctor-Chunker</a>. &nbsp;&nbsp;"


chunk: $(CHUNK)

single: $(SINGLE)

# fetch the asciidoctor.org site
asciidoctor.org:
	git clone https://github.com/asciidoctor/asciidoctor.org.git -b docs-archive

# generate chunked html
$(CHUNK): $(SINGLE)
	$(ASCIIDOCTOR_CHUNKER_SCRIPT) $<  -o $(CHUNK_DIR)

# prepare images
$(SINGLE_IMG_DIR): asciidoctor.org $(SINGLE_DIR)
	cd $(SINGLE_OUTPUT); \
	ln -s ../asciidoctor.org/images ./ ;\
	cd -

$(SINGLE_DIR):
	mkdir -p $(SINGLE_DIR)

# generate single html
$(SINGLE): $(SINGLE_IMG_DIR) $(SINGLE_DIR)
	cd asciidoctor.org/docs; \
	asciidoctor -D ../../$(SINGLE_DIR) $(FOOTER) user-manual.adoc;\
	cd -

zip: $(CHUNK_OUTPUT)/user-manual.zip

$(CHUNK_OUTPUT)/user-manual.zip: $(CHUNK)
	cd $(CHUNK_OUTPUT); zip -r user-manual.zip html_chunk images; cd -

clean:
	rm -rf $(SINGLE_OUTPUT) $(CHUNK_OUTPUT) user-manual.zip
